---
# This playbook will run a BORG CREATE archive against all nodes in the cluster.

- hosts: all
  become: true
  serial: 1  # Run tasks one node at a time
  tasks:

    - name: Bring in secrets
      include_vars: var_secret.yaml # Decrypt and process vars from the project var_secret.yaml

    - name: Run export job
      ansible.builtin.set_fact:
        borg_passphrase: "{{ borgrepopw }}" # Setting in shell env var to the secret pulled value pulled in above
        random_number: "{{ 1000 | random }}"  # Should work for now but not an unrealistic chance for a collsition

    - name:  Run the Borg Create Job
      ignore_errors: yes  # We do this due to how BORG reports skipped files
      ansible.builtin.shell: |
        borgbackup create --show-rc  --stats --exclude /proc --exclude /run --exclude /sys borg@192.168.1.55:/mnt/borg::{{ ansible_hostname }}-{{ random_number }} /
      environment:
        BORG_PASSPHRASE: "{{ borg_passphrase }}"


